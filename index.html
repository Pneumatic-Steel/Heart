<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICU // MONITOR // FINAL_LOVE_V3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #0f0;
            font-family: 'Share Tech Mono', monospace;
            user-select: none;
        }

        /* --- THE CHASSIS --- */
        #monitor-casing {
            width: 95vw;
            height: 90vh;
            background: #000;
            border: 6px solid #1a1a1a;
            border-radius: 10px;
            box-shadow: 0 0 100px rgba(0,255,0,0.02);
            position: relative;
            overflow: hidden;
        }

        /* SCREEN INTERNALS */
        #screen {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #000000;
            /* CRT Scanline Effect */
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.5) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 4px, 3px 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,1);
            z-index: 1;
        }

        /* GRID OVERLAY */
        #grid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 50, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 50, 0.15) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 2;
            pointer-events: none;
            opacity: 0.8;
        }

        canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5;
            filter: blur(0.5px) contrast(1.5);
        }

        /* UI ELEMENTS */
        #sidebar {
            position: absolute;
            top: 30px; right: 30px;
            width: 220px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }

        .module {
            background: rgba(0, 10, 0, 0.8);
            border-left: 4px solid #003300;
            padding: 10px 15px;
            backdrop-filter: blur(2px);
        }

        .label {
            font-size: 12px;
            color: #008800;
            display: flex;
            justify-content: space-between;
            letter-spacing: 2px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .value {
            font-size: 45px;
            line-height: 45px;
            color: #ccffcc;
            text-shadow: 0 0 15px currentColor;
            font-weight: bold;
        }

        .sub-value { font-size: 16px; color: #006600; text-align: right; margin-top: 5px;}

        .color-bpm { color: #2ecc71; text-shadow: 0 0 10px #2ecc71; }
        .color-spo2 { color: #3498db; text-shadow: 0 0 10px #3498db; }
        .color-bp { color: #e74c3c; text-shadow: 0 0 10px #e74c3c; }

        #header {
            position: absolute;
            top: 30px; left: 30px;
            z-index: 10;
            pointer-events: none;
            border-bottom: 2px solid #003300;
            padding-bottom: 10px;
            width: 350px;
        }
        #patient-name { font-size: 28px; color: #fff; letter-spacing: 1px; text-shadow: 0 0 5px rgba(255,255,255,0.5); font-weight: bold; }
        #timestamp { font-size: 14px; color: #008800; margin-top: 5px; letter-spacing: 2px; }

        /* ALERT BOX */
        #alert-box {
            position: absolute;
            bottom: 60px; left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            font-size: 30px;
            background: rgba(20, 0, 0, 0.9);
            border: 2px solid #ff0000;
            color: #ff0000;
            padding: 15px 60px;
            letter-spacing: 5px;
            font-weight: bold;
            display: none;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
            text-align: center;
            text-shadow: 0 0 10px #f00;
        }

        #click-prompt {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            font-size: 20px;
            background: rgba(0,0,0,0.9);
            border: 2px solid #0f0;
            color: #0f0;
            padding: 25px 50px;
            cursor: pointer;
            box-shadow: 0 0 30px #0f0;
            letter-spacing: 4px;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
        }
        #click-prompt:hover { background: #0f0; color: #000; box-shadow: 0 0 80px #0f0; }
        
        .critical { animation: flashCrit 0.15s infinite; }
        @keyframes flashCrit { 
            0% { background: rgba(50,0,0,0.9); color:#f00; border-color:#f00; } 
            50% { background: rgba(255,0,0,0.4); color:#fff; border-color:#fff;} 
            100% { background: rgba(50,0,0,0.9); color:#f00; border-color:#f00;} 
        }

    </style>
</head>
<body>

<div id="monitor-casing">
    <div id="screen">
        <div id="grid"></div>
        
        <div id="header">
            <div id="patient-name">SUBJECT: HEIDI</div>
            <div id="timestamp">SYS.STATUS: LOCKED</div>
        </div>

        <div id="sidebar">
            <div class="module">
                <div class="label"><span>HR</span> <span>BPM</span></div>
                <div class="value color-bpm" id="bpm-display">--</div>
            </div>
            
            <div class="module">
                <div class="label"><span>SpO2</span> <span>%</span></div>
                <div class="value color-spo2" id="spo2-display">--</div>
            </div>

            <div class="module">
                <div class="label"><span>NIBP</span> <span>mmHg</span></div>
                <div class="value color-bp" style="font-size: 35px;" id="bp-display">-- / --</div>
                <div class="sub-value">MAP (100)</div>
            </div>
        </div>

        <div id="alert-box">
            <div>// !!!CARDIAC ARREST!!! //</div>
        </div>

        <canvas id="c"></canvas>
    </div>
</div>

<div id="click-prompt">[ INITIALIZE ]</div>

<script>
// --- AUDIO ENGINE ---
const AC = new (window.AudioContext || window.webkitAudioContext)();
const MASTER = AC.createGain();
const LIMITER = AC.createDynamicsCompressor();
const ANALYSER = AC.createAnalyser();

MASTER.gain.value = 0.6;
LIMITER.connect(ANALYSER);
ANALYSER.connect(AC.destination);
ANALYSER.fftSize = 2048; 
ANALYSER.smoothingTimeConstant = 0.85; 
MASTER.connect(LIMITER);

// --- VITALS SIMULATOR ---
let vitals = { bpm: 140, spo2: 98, sys: 120, dia: 80 };

setInterval(() => {
    if (!isPlaying) return;
    vitals.spo2 = 96 + Math.floor(Math.random() * 4);
    vitals.sys = 118 + Math.floor(Math.random() * 5);
    vitals.dia = 78 + Math.floor(Math.random() * 5);
    document.getElementById('spo2-display').innerText = vitals.spo2;
    document.getElementById('bp-display').innerText = `${vitals.sys} / ${vitals.dia}`;
    const d = new Date();
    document.getElementById('timestamp').innerText = "UPDATED: " + d.toLocaleTimeString();
}, 1000);

function flashBPM() {
    const el = document.getElementById('bpm-display');
    const drift = (Math.random()-0.5);
    el.innerText = Math.floor(140 + drift);
    el.style.opacity = 1;
    el.style.textShadow = "0 0 25px #fff";
    setTimeout(() => { 
        el.style.opacity = 0.8; 
        el.style.textShadow = "0 0 10px currentColor";
    }, 100);
}

// --- AUDIO DSP ---
function kick(t) {
    const osc = AC.createOscillator();
    const g = AC.createGain();
    osc.frequency.setValueAtTime(150, t);
    osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
    g.gain.setValueAtTime(1, t);
    g.gain.exponentialRampToValueAtTime(0.01, t + 0.4);
    const d = AC.createWaveShaper();
    d.curve = new Float32Array([-1, 1]); 
    osc.connect(d); d.connect(g); g.connect(MASTER);
    osc.start(t); osc.stop(t+0.4);
}

function snare(t) {
    const buf = AC.createBuffer(1, AC.sampleRate*0.2, AC.sampleRate);
    const d = buf.getChannelData(0);
    for(let i=0; i<d.length; i++) d[i]=(Math.random()*2-1);
    const n = AC.createBufferSource();
    n.buffer = buf;
    const f = AC.createBiquadFilter();
    f.type = 'highpass';
    f.frequency.value = 1000;
    const g = AC.createGain();
    g.gain.setValueAtTime(1, t);
    g.gain.exponentialRampToValueAtTime(0.01, t+0.2);
    n.connect(f); f.connect(g); g.connect(MASTER);
    n.start(t);
    const osc = AC.createOscillator();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(200, t);
    const og = AC.createGain();
    og.gain.setValueAtTime(0.8, t);
    og.gain.exponentialRampToValueAtTime(0.01, t+0.1);
    osc.connect(og); og.connect(MASTER);
    osc.start(t); osc.stop(t+0.1);
}

function hat(t, open) {
    const buf = AC.createBuffer(1, AC.sampleRate*0.05, AC.sampleRate);
    const d = buf.getChannelData(0);
    for(let i=0; i<d.length; i++) d[i]=(Math.random()*2-1);
    const n = AC.createBufferSource();
    n.buffer = buf;
    const f = AC.createBiquadFilter();
    f.type = 'highpass';
    f.frequency.value = 6000;
    const g = AC.createGain();
    g.gain.value = open ? 0.2 : 0.05;
    g.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
    n.connect(f); f.connect(g); g.connect(MASTER);
    n.start(t);
}

function bass(t, dur, note, type) {
    const osc = AC.createOscillator();
    const mod = AC.createOscillator();
    const modG = AC.createGain();
    const filter = AC.createBiquadFilter();
    const dist = AC.createWaveShaper();
    const amp = AC.createGain();

    const freqs = { 'F': 43.65, 'G#': 51.91, 'A#': 58.27, 'C': 65.41, 'C#': 69.30 };
    const f = freqs[note] || 43.65;

    function makeCurve(amount) {
        const k = amount;
        const n_samples = 44100;
        const curve = new Float32Array(n_samples);
        for (let i = 0; i < n_samples; ++i) {
            const x = i * 2 / n_samples - 1;
            curve[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
        }
        return curve;
    }
    dist.curve = makeCurve(300);

    osc.frequency.setValueAtTime(f, t);
    mod.frequency.setValueAtTime(f, t);

    if (type === 'WOBBLE') {
        osc.type = 'sawtooth';
        mod.type = 'sine';
        modG.gain.value = 100; 
        filter.type = 'lowpass';
        filter.Q.value = 10;
        filter.frequency.setValueAtTime(100, t);
        filter.frequency.linearRampToValueAtTime(1200, t + dur/2);
        filter.frequency.linearRampToValueAtTime(100, t + dur);
    } 
    else if (type === 'GROWL') {
        osc.type = 'sawtooth';
        mod.type = 'square';
        modG.gain.setValueAtTime(f*3, t);
        filter.type = 'peaking';
        filter.Q.value = 1;
        filter.gain.value = 25;
        filter.frequency.setValueAtTime(400, t);
        filter.frequency.linearRampToValueAtTime(2500, t + dur);
    }
    else if (type === 'REESE') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(f-1, t);
        mod.type = 'sawtooth';
        mod.frequency.setValueAtTime(f+1, t);
        modG.gain.value = 0.5;
        filter.type = 'lowpass';
        filter.frequency.value = 1200;
        mod.connect(amp);
    }

    if (type !== 'REESE') {
        mod.connect(modG);
        modG.connect(osc.frequency);
        osc.connect(filter);
        filter.connect(dist);
        dist.connect(amp);
    } else {
        osc.connect(filter);
        filter.connect(amp);
    }

    amp.connect(MASTER);
    amp.gain.setValueAtTime(0, t);
    amp.gain.linearRampToValueAtTime(type==='REESE'?0.6:1, t+0.05);
    amp.gain.linearRampToValueAtTime(0, t+dur);

    osc.start(t); mod.start(t);
    osc.stop(t+dur); mod.stop(t+dur);
}

function lead(t, note) {
    const osc = AC.createOscillator();
    osc.type = 'square';
    osc.frequency.value = note;
    const g = AC.createGain();
    g.gain.setValueAtTime(0.1, t);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.15);
    const delay = AC.createDelay();
    delay.delayTime.value = 0.214; 
    const fb = AC.createGain();
    fb.gain.value = 0.4;
    osc.connect(g);
    g.connect(MASTER);
    g.connect(delay);
    delay.connect(fb);
    fb.connect(delay);
    delay.connect(MASTER);
    osc.start(t); osc.stop(t+0.2);
}

// --- SEQUENCER ---
const BPM = 140;
const BEAT = 60 / BPM;
const BAR = BEAT * 4;

let currentBar = 0;
let nextTime = 0;
let isPlaying = false;
let section = "IDLE";

function scheduler() {
    if(!isPlaying) return;
    while(nextTime < AC.currentTime + 0.1) {
        playBar(currentBar, nextTime);
        
        if(currentBar < 8) section = "INTRO";
        else if(currentBar < 16) section = "BUILD";
        else if(currentBar < 32) section = "DROP";
        else if(currentBar < 40) section = "BREAK";
        else if(currentBar < 56) section = "DROP";
        else section = "OUTRO";
        
        // --- REACTIVE UI LOGIC ---
        const alertBox = document.getElementById('alert-box');
        
        if (section === "DROP") {
            alertBox.style.display = "block";
            alertBox.classList.add("critical");
        } 
        else {
            alertBox.style.display = "none";
            alertBox.classList.remove("critical");
        }

        for(let i=0; i<4; i++) {
             setTimeout(flashBPM, (nextTime - AC.currentTime + i*BEAT) * 1000);
        }

        nextTime += BAR;
        currentBar++;
    }
    setTimeout(scheduler, 50);
}

function playBar(bar, t) {
    if (bar < 8) {
        if(bar % 2 === 0) bass(t, BAR, 'F', 'REESE');
        else bass(t, BAR, 'C#', 'REESE');
        for(let i=0; i<16; i++) if(i%2!==0) hat(t + i*(BEAT/4), false);
        if(bar > 3) { kick(t); kick(t + BEAT*2.5); }
    }
    else if (bar < 16) {
        const intensity = (bar - 8) / 8;
        let subdivision = BEAT;
        if(bar >= 12) subdivision = BEAT/2;
        if(bar >= 14) subdivision = BEAT/4;
        if(bar === 15) subdivision = BEAT/8;
        for(let time = 0; time < BAR; time += subdivision) snare(t + time);
        const osc = AC.createOscillator();
        osc.frequency.setValueAtTime(200 + (bar-8)*100, t);
        osc.frequency.linearRampToValueAtTime(200 + (bar-7)*100, t+BAR);
        const g = AC.createGain();
        g.gain.value = 0.2 * intensity;
        osc.connect(g); g.connect(MASTER);
        osc.start(t); osc.stop(t+BAR);
    }
    else if (bar < 32) {
        kick(t); snare(t + BEAT*2); kick(t + BEAT*3.5);
        const local = bar % 4;
        if (local === 0) { bass(t, BEAT*2.5, 'F', 'GROWL'); bass(t + BEAT*3, BEAT, 'F', 'WOBBLE'); }
        else if (local === 1) { bass(t, BEAT, 'G#', 'GROWL'); bass(t + BEAT, BEAT, 'G#', 'GROWL'); bass(t + BEAT*2.5, BEAT*1.5, 'C', 'WOBBLE'); }
        else if (local === 2) { bass(t, BEAT*2, 'F', 'GROWL'); bass(t + BEAT*2, BEAT*2, 'F', 'GROWL'); }
        else { bass(t, BEAT, 'C#', 'WOBBLE'); bass(t + BEAT, BEAT, 'C', 'WOBBLE'); bass(t + BEAT*2, BEAT, 'A#', 'WOBBLE'); bass(t + BEAT*3, BEAT, 'G#', 'WOBBLE'); }
    }
    else if (bar < 40) {
        const arp = [440, 523, 698, 880];
        for(let i=0; i<16; i++) lead(t + i*(BEAT/4), arp[i%4] * (bar%2==0 ? 1 : 1.5));
        bass(t, BAR, 'F', 'REESE');
    }
    else if (bar < 56) {
        kick(t); snare(t+BEAT*2); if(bar % 2 === 0) kick(t+BEAT*1.5);
        const triplet = BEAT/3;
        for(let i=0; i<12; i++) if(Math.random() > 0.5) bass(t + i*triplet, triplet, 'F', 'GROWL');
        if(bar % 4 === 3) lead(t, 880); 
    }
}

// --- VISUAL RENDERER ---

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let points = [];
const N_POINTS = 600; 

// Calculate Heart Points
for(let i=0; i<N_POINTS; i++) {
    const t = (i/N_POINTS)*Math.PI*2;
    const x = 16 * Math.pow(Math.sin(t), 3);
    const y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
    points.push({x, y});
}

// Particle System
let particles = [];
class Particle {
    constructor(x, y, color, speedMulti) {
        this.x = x; this.y = y;
        const angle = Math.random() * Math.PI * 2;
        const spd = (Math.random() * speedMulti) + 0.5;
        this.vx = Math.cos(angle) * spd;
        this.vy = Math.sin(angle) * spd;
        this.life = 1.0;
        this.color = color;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life -= 0.03; 
    }
    draw(ctx) {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, 2, 2); 
        ctx.globalAlpha = 1;
    }
}

let dotPos = 0; // NEW: Track position of the scanner dot

function draw() {
    requestAnimationFrame(draw);
    
    // --- HIGH-DPI FIX ---
    // This checks if the screen resolution (Retina/Mobile) is higher than the canvas size
    const dpr = window.devicePixelRatio || 1;
    const rect = document.getElementById('screen').getBoundingClientRect();
    
    if(canvas.width !== rect.width * dpr || canvas.height !== rect.height * dpr) {
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr); // Scale context to match
    }

    const cx = rect.width/2;
    const cy = rect.height/2;

    // FADE & CLEAR (TRANSPARENCY FIX)
    ctx.globalCompositeOperation = 'destination-out';
    ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; 
    ctx.fillRect(0, 0, rect.width, rect.height);
    ctx.globalCompositeOperation = 'source-over';

    const bufferLength = ANALYSER.frequencyBinCount;
    const timeData = new Uint8Array(bufferLength);
    ANALYSER.getByteTimeDomainData(timeData);
    const freqData = new Uint8Array(bufferLength);
    ANALYSER.getByteFrequencyData(freqData);
    
    // Calculate Bass Energy for Pulse
    let bassVal = 0;
    for(let i=0; i<15; i++) bassVal += freqData[i];
    bassVal = bassVal / 15 / 255; 

    // Aesthetic Config
    let mainColor, glowColor, chaos;
    if (section === "DROP") {
        mainColor = '#ff0055';
        glowColor = '#ff0000';
        chaos = true;
    } else if (section === "BUILD") {
        mainColor = '#ffff00';
        glowColor = '#ffaa00';
        chaos = false;
    } else {
        mainColor = '#00ffaa'; 
        glowColor = '#00ff00';
        chaos = false;
    }

    // --- DRAW HEART ---
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.globalCompositeOperation = 'lighter'; 

    const scaleBase = Math.min(rect.width, rect.height) / 45;
    const pulse = 1 + (bassVal * 0.5); 
    const scale = scaleBase * pulse;

    ctx.beginPath();
    for(let i=0; i<N_POINTS; i++) {
        const p = points[i];
        
        // Map audio waveform
        const idx = Math.floor((i/N_POINTS) * timeData.length);
        const sig = (timeData[idx] / 128.0) - 1.0;
        
        let distort = sig * 0.5;
        if(chaos) distort *= 2.5; 

        const px = cx + (p.x * scale * (1 + distort));
        const py = cy + (p.y * scale * (1 + distort));

        if(i===0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);

        // Spawn particles (Limited)
        if (bassVal > 0.65 && Math.random() > 0.97) {
             const speed = chaos ? 8 : 3;
             particles.push(new Particle(px, py, glowColor, speed));
        }
    }
    ctx.closePath();
    
    // Draw styles
    ctx.shadowBlur = 0;
    ctx.strokeStyle = mainColor;
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.shadowBlur = 20;
    ctx.shadowColor = glowColor;
    ctx.lineWidth = 4;
    ctx.strokeStyle = glowColor;
    ctx.stroke();

    // --- THE SCANNER DOT (AUDIO REACTIVE) ---
    // Base speed (0.003) + Surge speed based on bass
    const speed = 0.003 + (bassVal * 0.05); 
    dotPos += speed;
    if(dotPos >= 1) dotPos = 0;

    const dotIdx = Math.floor(dotPos * N_POINTS);
    const pDot = points[dotIdx];
    const pxDot = cx + (pDot.x * scale);
    const pyDot = cy + (pDot.y * scale);
    
    ctx.beginPath();
    ctx.shadowBlur = 15;
    ctx.shadowColor = '#fff';
    ctx.fillStyle = '#fff';
    ctx.arc(pxDot, pyDot, 5, 0, Math.PI*2);
    ctx.fill();

    ctx.globalCompositeOperation = 'source-over'; 

    // --- PARTICLES ---
    for(let i=particles.length-1; i>=0; i--) {
        particles[i].update();
        particles[i].draw(ctx);
        if(particles[i].life <= 0) particles.splice(i, 1);
    }
}

document.getElementById('click-prompt').addEventListener('click', () => {
    if(isPlaying) return;
    AC.resume();
    isPlaying = true;
    document.getElementById('click-prompt').style.display = 'none';
    
    nextTime = AC.currentTime + 0.1;
    scheduler();
    draw();
});

</script>
</body>
</html>
